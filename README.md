# Инфраструктурный сценарий развертывания и управления MTProxy

Комплексное решение для автоматизации установки, настройки и эксплуатации сервера MTProxy на дистрибутивах Ubuntu 22.04 LTS и 24.04 LTS. Сценарий ориентирован на обеспечение высокого уровня безопасности, маскировку трафика и отказоустойчивость.

## Технические характеристики и функциональные возможности

### Обфускация протокола и обход блокировок
*   **Реализация Fake TLS**: Использование режима эмуляции TLS (параметр `--domain` и секреты с префиксом `ee`) для маскировки прокси-трафика под стандартные HTTPS-сессии.
*   **Противодействие DPI (Deep Packet Inspection)**: Настройка модулей `iptables hashlimit` для ограничения частоты новых соединений, что снижает вероятность идентификации сервера системами технического анализа трафика (ТСПУ).
*   **Имитация легитимного трафика**: Эмуляция расширения SNI (Server Name Indication) для соответствия трафика структуре запросов к доверенным доменам (например, Google, Microsoft).

### Архитектура безопасности
*   **Изоляция привилегий**: Служба функционирует в контексте выделенного системного пользователя `mtproxy` с минимально необходимым набором прав доступа. Использование учетной записи `nobody` исключено в целях повышения безопасности.
*   **Изоляция учетных данных**: Хранение криптографических секретов в директории `/etc/mtproxy/` с правами доступа `0600`. Это исключает возможность компрометации ключей через средства интроспекции systemd и общесистемные логи.
*   **Сохранение состояния (Persistence)**: Интеграция с `netfilter-persistent` для обеспечения сохранности правил межсетевого экрана после перезагрузки узла.

### Автоматизация обслуживания
*   **Контроль целостности конфигурации**: Механизм ежедневного обновления параметров Telegram включает стадию предварительной валидации. При обнаружении некорректных данных (пустые файлы или поврежденные конфиги) система выполняет автоматический откат к последней стабильной копии.
*   **Каскадное определение сетевых параметров**: Алгоритм идентификации внешнего IPv4-адреса использует цепочку из 8 независимых сервисов с финальным fallback-вариантом через маршрутизацию хоста.

## Порядок развертывания

Для инициализации процесса установки на подготовленном сервере выполните следующую команду:

```bash
git clone https://github.com/lingeniare/MTProxy.git && cd MTProxy && sudo bash install_mtproxy.sh
```

## Параметры конфигурации

Сценарий поддерживает следующие аргументы командной строки:

| Аргумент | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `--domain`, `-D` | Целевой домен для эмуляции TLS SNI | `www.google.com` |
| `--tag`, `-P` | Рекламный тег (Sponsorship tag), полученный у @MTProxybot | (Опционально) |
| `--rate-limit` | Лимит частоты новых соединений на один IP-источник | `5/min` |
| `--rate-burst` | Допустимый всплеск (burst) для пакетного фильтра | `10` |

## Администрирование и диагностика

Управление службой осуществляется стандартными средствами `systemd`:

```bash
systemctl status MTProxy     # Проверка статуса службы
systemctl restart MTProxy    # Перезагрузка сервиса
curl localhost:2398/stats    # Получение диагностической статистики
```

## Деинсталляция

Для полного удаления всех компонентов системы (пользователя, конфигурационных файлов и правил фильтрации) выполните:

```bash
sudo bash uninstall_mtproxy.sh
```
