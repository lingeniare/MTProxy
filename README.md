# Инфраструктурный сценарий развертывания MTProxy

Автоматизированное решение для установки и эксплуатации сервера MTProxy на Ubuntu 22.04/24.04 LTS. Сборка выполняется из официальных исходных кодов Telegram с акцентом на безопасность и противодействие DPI.

Все параметры рассчитаны автоматически. Пользователю достаточно выполнить одну команду.

## Развертывание

```bash
git clone https://github.com/lingeniare/MTProxy.git && cd MTProxy && sudo bash install_mtproxy.sh
```

После завершения скрипт выведет готовую ссылку для подключения. Откройте её на телефоне — Telegram подхватит прокси автоматически.

## Что выполняет сценарий

1. Устанавливает системные зависимости (включая cron, если отсутствует).
2. Создает изолированного системного пользователя `mtproxy`.
3. Компилирует MTProxy из официального репозитория.
4. Загружает и валидирует конфигурационные файлы Telegram.
5. Генерирует криптографический секрет и активирует Fake TLS.
6. Автоматически определяет NAT-конфигурацию для облачных VPS.
7. Регистрирует systemd-сервис с автозапуском, ограничением restart-storm и диагностическим эндпоинтом.
8. Настраивает ограничение частоты соединений через iptables.
9. Создает задание планировщика для ежедневного обновления конфигурации Telegram с проверкой целостности и автоматическим откатом.
10. Открывает порт в межсетевом экране и сохраняет правила на случай перезагрузки.

## Архитектура безопасности

| Механизм | Реализация |
|----------|------------|
| Изоляция привилегий | Выделенный системный пользователь `mtproxy` |
| Защита секретов | Хранилище `/etc/mtproxy/secret` с правами доступа `0600` |
| Обфускация протокола | Fake TLS с эмуляцией TLS SNI (`ee`-секрет) |
| Противодействие DPI | Rate-limiting через `iptables hashlimit` |
| Устойчивость | Сохранение правил через `netfilter-persistent` |
| Автообновление | Ежедневная синхронизация с серверами Telegram (с валидацией и откатом) |
| NAT | Автоматическое определение `--nat-info` для облачных окружений |

## Дополнительные параметры

Для большинства случаев параметры указывать не требуется. Значения по умолчанию оптимальны для небольших групп пользователей (до 5 человек).

| Аргумент | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `--domain`, `-D` | Домен для эмуляции TLS SNI | `www.google.com` |
| `--tag`, `-P` | Тег из @MTProxybot | (опционально) |
| `--rate-limit` | Лимит новых соединений на IP | `5/min` |
| `--rate-burst` | Допустимый всплеск | `10` |

Переменные окружения:

| Переменная | Описание | Значение по умолчанию |
|------------|----------|-----------------------|
| `FORCE_UNSHARE=auto\|1\|0` | Режим PID namespace workaround: `auto` включает `unshare`, если `pid_max > 65535` или `ns_last_pid > 65535`; `1` включает всегда; `0` отключает | `auto` |

## Workaround для PID > 65535

На системах с большим `kernel.pid_max` (например `4194304`) MTProxy может падать при старте с assert:

```text
mtproto-proxy: common/pid.c:42: init_common_PID: Assertion `!(p & 0xffff0000)' failed.
```

Причина: текущая версия `mtproto-proxy` ожидает PID в 16-битном диапазоне, а systemd может выдать процессу PID больше `65535`.

Скрипт автоматически включает локальный workaround через PID namespace (совместимо с Ubuntu 24.04 / systemd 255):

```text
/usr/bin/unshare --pid --fork --mount-proc -- /opt/MTProxy/objs/bin/mtproto-proxy ...
```

Это не меняет глобальные sysctl и не требует контейнеризации. В unit также добавлены:

- `StartLimitIntervalSec=60`
- `StartLimitBurst=5`

чтобы ограничить restart-storm при повторных ошибках старта.

Проверка:

1. `systemctl cat MTProxy` — в `ExecStart` должен быть `unshare`, если workaround активирован.
2. `journalctl -u MTProxy -f` — в логах MTProxy PID обычно видны как `[1]`, `[2]`.
3. `systemctl status MTProxy` — `MainPID` будет у `unshare`, дочерние `mtproto-proxy` работают в той же cgroup.

## Администрирование

```bash
systemctl status MTProxy          # Статус службы
systemctl restart MTProxy         # Перезапуск
journalctl -u MTProxy -f          # Журнал в реальном времени
curl localhost:2398/stats         # Диагностическая статистика
```

## Обновление скрипта

```bash
cd MTProxy && git pull && sudo bash install_mtproxy.sh
```

Повторный запуск сохраняет порт, секрет и домен из текущей конфигурации. Ранее выданные ссылки останутся рабочими.

## Деинсталляция

```bash
sudo bash uninstall_mtproxy.sh
```

## Ограничения

MTProxy проксирует только текстовые сообщения и медиафайлы. Голосовые и видеозвонки через MTProxy не поддерживаются. Для полноценной работы со звонками рекомендуется использовать WireGuard или AmneziaWG с раздельным туннелированием.

## Системные требования

- Ubuntu 22.04 LTS / 24.04 LTS
- Доступ с правами root
- Сетевое подключение к интернету
